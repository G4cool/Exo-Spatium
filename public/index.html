<html>
<head>
	<title>AeroBlue</title>
	<!--Import Google Icon Font-->
	<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    
    <script src="/socket.io/socket.io.js"></script>

    <style>
    	* {
		   margin: 0;
		   padding: 0;
		}

		#setUpDiv {
			position: absolute;
			background-color:rgba(0, 0, 0, 0.0);
			z-index: 2;
			overflow: hidden;
		}

		#setUpBackgroundImage {
			/*position: absolute;*/
			z-index: 1;
			/*background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('images/example.jpg') no-repeat center center fixed;*/
			/*background: no-repeat center center fixed;*/
			/*
			-webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
  			background-size: cover;
  			*/
  			overflow: hidden;
		}

		#setUpImage {
			filter: blur(5px);
        -webkit-filter: blur(5px);
        -moz-filter: blur(5px);
        -o-filter: blur(5px);
        -ms-filter: blur(5px);
    margin: -5px -10px -10px -5px;
		}

		#loadingAnimation {
			display: none;
    		position: absolute;
		    top: 50%;
		    left: 50%;
    		z-index: 3;
		}

		/*
        #gameOverDivContainer {
    		position: absolute;
            left: 25px;
            top: 100px;
    	}
    	*/

    	#killCounterContainer {
    		position: absolute;
            left: 25px;
            top: 25px;
    	}

    	#abletsAmountContainer {
    		position: absolute;
    		left: 25px;
    	}

    	#overlay {
		    position: fixed;
		    top:0;
		    bottom:0;
		    left:0;
		    right:0;
		    background-color:#000000;
		    opacity:0.8;
		    display:block;
		    z-index:1001;
		}

		#shop {
			position: absolute;
		    overflow-y: auto;
			z-index:1002;
		}

		#shopTitle {
			text-align: center;
			vertical-align: middle;
		}

		#abletsAmountShop {
			text-align: center;
			vertical-align: middle;
		}

		#changeShopBorder {
			border-width: 0px;
		}

		#buyDoubleShot:hover {
			transition: 0.4s ease;
			-webkit-transform: scale(1.3);
            -ms-transform: scale(1.3);
            transform: scale(1.3);
		}

		#buyTripleShot:hover {
			transition: 0.4s ease;
			-webkit-transform: scale(1.3);
            -ms-transform: scale(1.3);
            transform: scale(1.3);
		}

		#buyQuadrupleShot:hover {
			transition: 0.4s ease;
			-webkit-transform: scale(1.3);
            -ms-transform: scale(1.3);
            transform: scale(1.3);
		}

		#buyQuintupleShot:hover {
			transition: 0.4s ease;
			-webkit-transform: scale(1.3);
            -ms-transform: scale(1.3);
            transform: scale(1.3);
		}

    </style>
</head>
<body>
	<div id="setUpDiv" class="row">
		<script type="text/javascript">
			document.getElementById("setUpDiv").style.width = window.innerWidth;
			document.getElementById("setUpDiv").style.height = window.innerHeight;
		</script>
   		<div class="col s12">
        	<div class="card-panel blue z-depth-0 darken-1">
          		<div class="row">
          			<form id="usernameForm" onsubmit="return false" class="col s12">
						<div id="usernameContainer" class="row">
				        	<div class="input-field col s12">
				        		<input id="usernameTextbox" type="text" class="validate">
				        		<label for="usernameTextbox" class="white-text">Username</label>
				        	</div>
				    	</div>
					</form>
					<button id="submitButton" onclick="updateLobbyClient()" class="btn blue z-depth-0 lighten-1 waves-effect waves-light" type="submit" name="action">Submit
    					<i class="material-icons right">send</i>
 					</button>
          		</div>
        	</div>
      	</div>
    </div>
    <div id="setUpBackgroundImage">
    	<script type="text/javascript">
			document.getElementById("setUpBackgroundImage").style.width = window.innerWidth;
			document.getElementById("setUpBackgroundImage").style.height = window.innerHeight;
		</script>
		<img id="setUpImage" src="images/example.jpg"/>
    </div>
    <!--MAKE CUSTOM ANIMATION!-->
    <div id="loadingAnimation" class="preloader-wrapper big active">
	    <div class="spinner-layer spinner-blue-only">
	      	<div class="circle-clipper left">
	        	<div class="circle"></div>
	      	</div>
	      	<div class="gap-patch">
	        	<div class="circle"></div>
	      	</div>
	      	<div class="circle-clipper right">
	        	<div class="circle"></div>
	      	</div>
	    </div>
	</div>
	<!--<div id="gameOverDivContainer" class="row" style="display: none;">
      	<div class="col s12">
        	<div class="card-panel card-panel blue z-depth-0 darken-4">
          		<div id="gameOverDiv"></div>
        	</div>
    	</div>
    </div>-->
    <div id="killCounterContainer" class="row" style="display: none;">
      	<div class="col s12">
        	<div class="card-panel blue z-depth-0 darken-4">
          		<div id="killCounter"></div>
        	</div>
    	</div>
    </div>
    <div id="abletsAmountContainer" class="row" style="display: none;">
      	<div class="col s12">
        	<div class="card-panel blue z-depth-0 darken-4">
          		<div id="abletsAmount"></div>
        	</div>
    	</div>
    </div>
	<div id="gameDiv" style="display: none;">
		<canvas id="myCanvas" width="800" height="800"></canvas>
		<script>
				document.getElementById("myCanvas").width = window.innerWidth;
				document.getElementById("myCanvas").height = window.innerHeight;

	        //$(function(){
	            var clients = {};
	            var clientNum = 0;
				var clearW = window.innerWidth;
				var clearH = window.innerHeight;
				var x = 50
				var y = 50
				var dx = 0
				var dy = 0
				var ddx = 1
				var ddy = 1
				var xMessage = []
				var yMessage = []
				var dxMessage = []
				var dyMessage = []
				var xOther = 0	// CHANGE TO ARRAY OR OBJECT TO ALLOW FOR MORE THAN TWO PLAYERS!
				var yOther = 0	// CHANGE TO ARRAY OR OBJECT TO ALLOW FOR MORE THAN TWO PLAYERS!
				var dxOther = 0	// CHANGE TO ARRAY OR OBJECT TO ALLOW FOR MORE THAN TWO PLAYERS!
				var dyOther = 0	// CHANGE TO ARRAY OR OBJECT TO ALLOW FOR MORE THAN TWO PLAYERS!
				var myId = ""
				var id = 0
				var cirlces = {};

				var myIndex = 0;
				var myX = 0;
				var myY = 0;
				var myBulletX = 0;
				var myBulletY = 0;
				var myXFromCenter = 0;
				var myYFromCenter = 0;
				var myBulletXFromCenter = 0;
				var myBulletYFromCenter = 0;
				var correctX = 0;
				var correctY = 0;
				var correctBulletX = 0;
				var correctBulletY = 0;

				var backX = 0;
				var backY = 0

				var playerList = [];

				var disableSpace = false;

				var username = "";

				var angle = 0;

				var socket = io();

				var c = document.getElementById("myCanvas");
				var ctx = c.getContext("2d");
				var shipWidth = 50; // placeholder until image loads
				var shipHeight = 50; // placeholder until image loads
				var ready = 'b';
				const radius = 5;

				var inYet = false;

				var alive = true;

				var goBackToGame = false;

				var shopShown = false;

				var doneWithShop = true;

				var overYet = false;

				var minimapRadius = 50;
				var minimapXCenter = window.innerWidth - (minimapRadius + 10);
				var minimapYCenter = minimapRadius + 10;
				var minimapPlayerWidth = 4;
				var minimapPlayerHeight = 4;

				//client keyboard and mouse states
				var rightkeydown = false;
				var leftkeydown = false;
				var upkeydown = false;
				var downkeydown = false;
				var spacekeydown = false;
				var mouseX = 0;
				var mouseY = 0;

				var totalSeconds = 0;

				var shipImg = new Image();
				shipImg.src = 'images/ship6.png';
				var enemyShipImg = new Image();
				enemyShipImg.src = 'images/enemy ship6.png';
				var starBackground = new Image();
				starBackground.src = 'images/starBackground4.png';
				var laserImg = new Image();
				laserImg.src = 'images/laser.png';
				var enemyLaserImg = new Image();
				enemyLaserImg.src = 'images/enemy laser.png';

				var usernameSubmit = document.getElementById("usernameTextbox");
				usernameSubmit.addEventListener("keydown", function (e) {
				    if (e.keyCode === 13) {  //checks whether the pressed key is "Enter"
				        validate(e);
				    }
				});

				function validate(e) {
					updateLobbyClient();
				}

				function sendData(){
					var data = [rightkeydown, leftkeydown, upkeydown, downkeydown, spacekeydown, mouseX, mouseY, window.innerWidth, window.innerHeight, angle, shipImg.width, shipImg.height, alive];
					socket.emit('user_input_state', data);
					//console.log("trying to send user input");
				}

				window.onkeydown = function(e){
					var key=e.keyCode ? e.keyCode : e.which;
					if (inYet == true) {
						if (key===65) leftkeydown = true;
						if (key===68) rightkeydown = true;
						if (key===87) upkeydown = true;
						if (key===83) downkeydown = true;
						if (key===32) spacekeydown = true;
					}
					sendData();
					if (disableSpace == true) {
						return !(e.keyCode == 32);
					}
				}

				window.onkeyup = function(e){
					var key=e.keyCode ? e.keyCode : e.which;
					if (key===65) leftkeydown = false;
					if (key===68) rightkeydown = false;
					if (key===87) upkeydown = false;
					if (key===83) downkeydown = false;
					if (key===32) spacekeydown = false;
					sendData();
				}

				window.onmousemove = function(e){
					mouseX = e.clientX;
					mouseY = e.clientY;
					sendData();
				}

				function updateLobbyClient(){
					document.getElementById("loadingAnimation").style.display = "block";
					$('#setUpDiv').css({
                                'filter': 'blur(2px)',
                                '-webkit-filter': 'blur(2px)',
                                '-moz-filter': 'blur(2px)',
                                '-o-filter': 'blur(2px)',
                                '-ms-filter': 'blur(2px)',
                    });
                    $('#setUpBackgroundImage').css({
                    			//'background-size': 'auto 150%',
                                'filter': 'blur(2px)',
                                '-webkit-filter': 'blur(2px)',
                                '-moz-filter': 'blur(2px)',
                                '-o-filter': 'blur(2px)',
                                '-ms-filter': 'blur(2px)',
                    });
                    setTimeout(function(){
                    	$("#setUpDiv").fadeOut(1000);
                    	$("#setUpBackgroundImage").fadeOut(1000);
                    	$("#loadingAnimation").fadeOut(250);
                    }, 1000);
					setTimeout(function(){
						document.getElementById("setUpDiv").style.display = "none";
						document.getElementById("loadingAnimation").style.display = "none";
						username = document.getElementById("usernameTextbox").value;
						socket.emit('username', username);
						$('#setUpDiv').css({
	                                'filter': 'blur(0px)',
	                                '-webkit-filter': 'blur(0px)',
	                                '-moz-filter': 'blur(0px)',
	                                '-o-filter': 'blur(0px)',
	                                '-ms-filter': 'blur(0px)',
	                    });
						document.getElementById("setUpDiv").style.display = "none";
						document.getElementById("killCounterContainer").style.display = "block";
						document.getElementById("abletsAmountContainer").style.top = (window.innerHeight - 100) + "px";
						document.getElementById("abletsAmountContainer").style.display = "block";
						document.getElementById("gameDiv").style.display = "block";
						inYet = true;
						disableSpace = true;
					}, 2000);
				}

				function finishShop() {
					document.getElementById("overlay").style.display = "none";
					document.getElementById("shop").style.display = "none";
					doneWithShop = true;
					inYet = true;
					goBackToGame = true;
					console.log('go back to game');
				}

				function buyDoubleShot() {
					socket.emit('boughtDoubleShot',"They bought double shot.");
				}

				function buyTripleShot() {
					socket.emit('boughtTripleShot',"They bought triple shot.");
				}

				function buyQuadrupleShot() {
					socket.emit('boughtQuadrupleShot',"They bought quadruple shot.");
				}

				function buyQuintupleShot() {
					socket.emit('boughtQuintupleShot',"They bought quintuple shot.");
				}

				function drawPlayer(x, y, color, index, rotation, imgWidth, imgHeight) {
					ctx.save();

					ctx.fillRect((window.innerWidth + 20), (window.innerHeight + 20), 200, 160);

					var xDistFromCenterOfMinimap = minimapXCenter + x/500;
					var yDistFromCenterOfMinimap = minimapYCenter + y/500;
					var myXDistFromCenterOfMinimap;
					var myYDistFromCenterOfMinimap;

				    if (index == myIndex) {
				    	ctx.save();
						ctx.fillStyle = "#FFFFFF";
						ctx.fillRect((minimapXCenter - (minimapPlayerWidth/2)), (minimapYCenter - (minimapPlayerHeight/2)), minimapPlayerWidth, minimapPlayerHeight);

						var myXDistFromCenterOfMinimap = minimapXCenter + x/500;
						var myYDistFromCenterOfMinimap = minimapYCenter + y/500;

				    	ctx.translate((window.innerWidth/2 + shipImg.width/2), (window.innerHeight/2 + shipImg.height/2));

						angle = -Math.atan2((window.innerWidth/2 - mouseX),(window.innerHeight/2 - mouseY));

						ctx.rotate(angle);

						ctx.translate(-(window.innerWidth/2 + shipImg.width/2), -(window.innerHeight/2 + shipImg.height/2));

				    	myX = x;
				    	myY = y;
				    	myXFromCenter = (window.innerWidth/2) - x;
				    	myYFromCenter = (window.innerHeight/2) - y;
						ctx.drawImage(shipImg, (window.innerWidth/2), (window.innerHeight/2));

						ctx.restore();
					} else {
						ctx.save();

						correctX = x + myXFromCenter;
						correctY = y + myYFromCenter;

						var otherX = (x - myX)/500;
						var otherY = (y - myY)/500;

						ctx.fillStyle = "red";
						ctx.fillRect((otherX + minimapXCenter - (minimapPlayerWidth/2)), (otherY + minimapYCenter - (minimapPlayerHeight/2)), minimapPlayerWidth, minimapPlayerHeight);

						ctx.translate((correctX + shipImg.width/2), (correctY + shipImg.height/2));
						ctx.rotate(rotation);
						ctx.translate(-(correctX + shipImg.width/2), -(correctY + shipImg.height/2));				

						ctx.drawImage(enemyShipImg, correctX, correctY);
					}

					ctx.restore();
				}

				function drawBullet(bullet, rotation, index) {
					if (index == myIndex) {
						ctx.save();
						myBulletX = bullet.x;
						myBulletY = bullet.y;
						myBulletXFromCenter = (window.innerWidth/2) - myX;
						myBulletYFromCenter = (window.innerHeight/2) - myY;
						angle = -Math.atan2((window.innerWidth/2 - mouseX),(window.innerHeight/2 - mouseY));
						ctx.translate((bullet.x + myBulletXFromCenter + shipImg.width/2 + laserImg.width/2), (bullet.y + myBulletYFromCenter + shipImg.height/2 + laserImg.height/2));
						ctx.rotate(rotation);
						console.log("rotation: " + rotation);
						ctx.translate(-(bullet.x + myBulletXFromCenter + shipImg.width/2 + laserImg.width/2), -(bullet.y + myBulletYFromCenter + shipImg.height/2 + laserImg.height/2));

						ctx.drawImage(laserImg, (bullet.x + myBulletXFromCenter + shipImg.width/2), (bullet.y + myBulletYFromCenter + shipImg.height/2));
					} else {
						ctx.save();
						correctBulletX = bullet.x + myXFromCenter;
						correctBulletY = bullet.y + myYFromCenter;
						ctx.translate(((correctBulletX + shipImg.width/2 + laserImg.width/2)),((correctBulletY + shipImg.height/2 + laserImg.height/2)));
						ctx.rotate(rotation);
						console.log("rotation: " + rotation);
						ctx.translate(-((correctBulletX + shipImg.width/2 + laserImg.width/2)),-((correctBulletY + shipImg.height/2 + laserImg.height/2)));
						ctx.drawImage(enemyLaserImg, (correctBulletX + shipImg.width/2), (correctBulletY + shipImg.height/2));
					}
					ctx.restore();
				}

				function drawBackground() {
					var pat = ctx.createPattern(starBackground, 'repeat');
					ctx.rect(0, 0, window.innerWidth, window.innerHeight);
					ctx.fillStyle = pat;
					ctx.fill();
				}

				function showShop() {
					document.getElementById("overlay").style.display = "block";
					document.getElementById("shop").style.width = window.innerWidth - 10 + "px";
					document.getElementById("shop").style.height = window.innerHeight - 10 + "px";
					document.getElementById("shop").style.left = ((window.innerWidth/2) - (parseInt(document.getElementById("shop").style.width)/2));
					document.getElementById("shop").style.top = ((window.innerHeight/2) - (parseInt(document.getElementById("shop").style.height)/2));
					document.getElementById("shop").style.display = "block";
					doneWithShop = false;
					goBackToGame = false;
					shopShown = false;
				}

				function draw(rightkeydown, leftkeydown, upkeydown, downkeydown) {
					var numImagesX = Math.ceil(c.width / starBackground.width) + 2;
					var numImagesY = Math.ceil(c.height / starBackground.height) + 2;

				    if (rightkeydown == true) {
				    	backX -= 3;
				    }
				    if (leftkeydown == true) {
				    	backX += 3;
				    }
				    if (upkeydown == true) {
				    	backY += 3;
				    }
				    if (downkeydown == true) {
				    	backY -= 3;
				    }

				    var repeatBackX = Math.ceil(backX / starBackground.width) + 1;
				    var repeatBackY = Math.ceil(backY / starBackground.height) + 1;

				    for (var i = 0; i < numImagesX; i++) {
						for (var j = 0; j < numImagesY; j++) {
					    	ctx.drawImage(starBackground, ((i - repeatBackX) * starBackground.width) + backX, ((j - repeatBackY) * starBackground.height) + backY);
						}
					}
				}

				socket.on('all_data', function(data){
					ctx.clearRect(0, 0, c.width, c.height);

					draw(rightkeydown, leftkeydown, upkeydown, downkeydown);

					document.getElementById("killCounter").innerHTML = data.killCounterString;
					document.getElementById("abletsAmount").innerHTML = "Ablets: " + data.players[myIndex].ablets;
					document.getElementById("abletsAmountShop").innerHTML = "Ablets: " + data.players[myIndex].ablets;

					// Draw minimap
					ctx.beginPath();
					ctx.fillStyle = "#000000";
					ctx.arc(minimapXCenter, minimapYCenter, minimapRadius, 0, 2 * Math.PI, false);
      				ctx.fill();
      				ctx.lineWidth = 1;
      				ctx.strokeStyle = "#FFFFFF";
      				ctx.stroke();
      				ctx.closePath();

      				ctx.beginPath();
      				ctx.arc(minimapXCenter, minimapYCenter, minimapRadius/2, 0, 2 * Math.PI, false);
      				ctx.lineWidth = 1;
      				ctx.strokeStyle = "#FFFFFF";
      				ctx.stroke();
      				ctx.closePath();

					for(var i = 0; i < data.players.length; i++){

						if (data.players[i].alive == true) {
							if (i != myIndex) {
							}
							drawPlayer(data.players[i].x, data.players[i].y, data.players[i].color, i, data.players[i].rotation, data.players[i].imgWidth, data.players[i].imgHeight);
							for (var j = 0; j < data.players[i].bullets.length; j++) {
								drawBullet(data.players[i].bullets[j], data.players[i].bullets[j].rotation, i);
							}
						}
					}

					if ((doneWithShop == true) && (alive == false)) {
						data.players[myIndex].alive = true;
						alive = true;
						sendData();
					}

					if (data.players[myIndex].alive == false) {
						alive = false;
						showShop();
					}
				});

				/*
				socket.on('connected', function (message) {
					document.getElementById("gameOverDivContainer").style.display = "none";
					document.getElementById("gameOverDiv").innerHTML = "";
				});
				*/

				socket.on('killConfirmed', function(message) {
					Materialize.toast(message, 3000, 'rounded')
				});

				socket.on('yourIndex', function (message) {
					myIndex = message;
				});

				/*
				socket.on('game_over', function(winner){
					if (inYet == false) {
						document.getElementById("gameOverDivContainer").style.display= "none";
					} else {
						document.getElementById("gameOverDivContainer").style.display= "block";
						document.getElementById("gameOverDiv").innerHTML = "Game Over!";
					}
				});
				*/
		</script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    	<script type="text/javascript" src="js/materialize.min.js"></script>
	</div>
	<div id="overlay" style="display: none;"></div>
	<div id="shop" style="display: none;">
   		<div class="col s12">
   			<!--<div class="row">
   				<div class="col s12">-->
		        	<div id="shopCard" class="card-panel blue z-depth-0 darken-1">
		        		<div id="abletsAmountShopCard" class="card-panel blue z-depth-0 lighten-1">
		        			<h5 id="abletsAmountShop"></h5>
		        		</div>
						<ul id="changeShopBorder" class="collection with-header blue z-depth-0 lighten-1">
					        <li class="collection-header blue z-depth-0 lighten-1"><h4>Shop</h4></li>
					        <li class="collection-item blue z-depth-0 lighten-1"><div>Double Shot: 100<a href="#!" class="secondary-content"><i id="buyDoubleShot" onclick="buyDoubleShot()" class="material-icons dp48">shopping_cart</i></a></div></li>
					        <li class="collection-item blue z-depth-0 lighten-1"><div>Triple Shot: 200<a href="#!" class="secondary-content"><i id="buyTripleShot" onclick="buyTripleShot()" class="material-icons dp48">shopping_cart</i></a></div></li>
					        <li class="collection-item blue z-depth-0 lighten-1"><div>Quadruple Shot: 300<a href="#!" class="secondary-content"><i id="buyQuadrupleShot" onclick="buyQuadrupleShot()" class="material-icons dp48">shopping_cart</i></a></div></li>
					        <li class="collection-item blue z-depth-0 lighten-1"><div>Quintuple Shot: 400<a href="#!" class="secondary-content"><i id="buyQuintupleShot" onclick="buyQuintupleShot()" class="material-icons dp48">shopping_cart</i></a></div></li>
					    </ul>
						<button id="shopButton" onclick="finishShop()" class="btn blue z-depth-0 lighten-1 waves-effect waves-light" type="submit" name="action">Go back to game
    						<i class="material-icons right">send</i>
 						</button>
		        	</div>
		        <!--</div>
	        </div>-->
      	</div>
    </div>
</body>
</html>









